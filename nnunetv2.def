Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04

%labels
    Author Jan
    Version nnU-Net v2 with residual encoder preset

%environment
    export PATH="/usr/local/bin:$PATH"
    export nnUNet_raw="/data/nnUNet_raw"
    export nnUNet_preprocessed="/data/nnUNet_preprocessed"
    export nnUNet_results="/data/nnUNet_results"
    export PYTHONPATH="/nnunet:$PYTHONPATH"

%post
    apt-get update && apt-get install -y git python3-pip

    # Upgrade pip
    python3 -m pip install --upgrade pip

    # Install PyTorch with CUDA 11.8 support (matches nvidia/cuda base image)
    python3 -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

    # Clone nnUNet v2 repo and install editable
    git clone https://github.com/MIC-DKFZ/nnUNet.git /nnunet
    cd /nnunet
    python3 -m pip install -e .

    # Install hiddenlayer for visualization
    python3 -m pip install --upgrade git+https://github.com/FabianIsensee/hiddenlayer.git

    # Cleanup to reduce image size
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    exec python3 "$@"

